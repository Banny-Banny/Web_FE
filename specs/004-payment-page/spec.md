# 토스 결제 페이지 명세서

**Feature Branch**: `feat/payment-page`  
**Created**: 2026-01-26  
**Status**: Draft  
**Input**: User description: "토스 결제를 위한 결제 페이지를 구현합니다."

## 📋 개요

### 프로젝트 목표
사용자가 타임캡슐 생성 과정에서 입력한 정보를 확인하고, 안전하고 편리하게 결제를 완료할 수 있는 페이지를 제공합니다.

### 비즈니스 가치
- **결제 전환율 향상**: 명확한 주문 정보 표시와 간편한 결제 프로세스로 사용자의 결제 완료율 향상
- **신뢰성 확보**: 주문 정보 요약과 결제 금액을 투명하게 표시하여 사용자 신뢰도 향상
- **사용자 경험 개선**: 이전 단계에서 입력한 정보를 확인하고, 안전한 결제 수단을 통해 빠르게 결제를 완료할 수 있도록 지원
- **비즈니스 성공**: 타임캡슐 생성 프로세스의 최종 단계를 완료하여 서비스 수익화 실현

### 범위
- **포함**: 
  - 이전 페이지에서 전달받은 타임캡슐 정보 표시 (캡슐명, 인원수, 가격)
  - 주문 정보 요약 및 결제 금액 표시
  - 토스 결제 위젯 연동 및 결제 프로세스 처리
  - 결제 전 주문 생성 및 주문 정보 조회
  - 토스 결제 완료 후 백엔드 최종 승인 요청
  - 결제 완료 후 처리 및 결과 표시
- **제외**: 
  - 결제 성공/실패 리다이렉트 페이지 (별도 기능)
  - 환불 및 취소 처리 (별도 기능)
  - 결제 내역 조회 (별도 기능)

---

## 🎯 사용자 시나리오

### US1: 사용자가 타임캡슐 주문 정보를 확인하고 결제를 진행 (Priority: P1)

**시나리오**: 사용자가 타임캡슐 생성 페이지에서 정보를 입력한 후 결제 페이지에 접근하여 주문 정보를 확인하고 결제를 완료할 때

**사용자 행동**:
1. 사용자가 결제 페이지에 접근
2. 사용자가 이전 단계에서 입력한 타임캡슐 정보(캡슐명, 인원수, 가격)를 확인
3. 사용자가 주문 정보 요약 및 결제 금액을 확인
4. 사용자가 결제 수단을 선택하고 결제 정보를 입력
5. 사용자가 결제를 진행
6. 시스템이 결제를 처리하고 결과를 표시

**기대 결과**:
- 사용자가 이전 단계에서 입력한 정보를 명확하게 확인할 수 있음
- 주문 정보와 결제 금액이 정확하게 표시됨
- 결제 프로세스가 안전하고 편리하게 진행됨
- 결제 완료 후 적절한 피드백이 제공됨

**성공 기준**:
- 사용자가 주문 정보를 확인하는 데 걸리는 시간이 10초 이하
- 결제 페이지 로드 후 주문 정보 표시 성공률 100%
- 결제 프로세스 완료까지 걸리는 시간이 2분 이하
- 결제 완료 성공률이 95% 이상

**Acceptance Scenarios**:
1. **Given** 사용자가 결제 페이지에 접근했을 때, **When** 페이지가 로드되면, **Then** 이전 단계에서 입력한 타임캡슐 정보가 표시됨
2. **Given** 사용자가 주문 정보를 확인했을 때, **When** 정보가 표시되면, **Then** 캡슐명, 인원수, 가격이 정확하게 표시됨
3. **Given** 사용자가 결제 금액을 확인했을 때, **When** 금액이 표시되면, **Then** 총 결제 금액이 명확하게 표시됨
4. **Given** 사용자가 결제를 진행했을 때, **When** 결제가 완료되면, **Then** 결제 완료 메시지가 표시됨

---

### US2: 사용자가 결제 전 주문 정보를 생성하고 확인 (Priority: P1)

**시나리오**: 사용자가 결제를 진행하기 전에 주문 정보가 생성되고, 생성된 주문 정보를 확인할 때

**사용자 행동**:
1. 사용자가 결제 페이지에 접근
2. 시스템이 자동으로 주문 정보를 생성
3. 사용자가 생성된 주문 정보를 확인
4. 사용자가 주문 정보가 올바른지 검증

**기대 결과**:
- 주문 정보가 자동으로 생성됨
- 생성된 주문 정보가 정확하게 표시됨
- 사용자가 주문 정보를 쉽게 확인할 수 있음
- 주문 정보 생성 실패 시 적절한 에러 메시지가 표시됨

**성공 기준**:
- 주문 정보 생성 성공률이 98% 이상
- 주문 정보 생성 시간이 2초 이하
- 주문 정보 표시 정확도 100%
- 주문 정보 생성 실패 시 에러 메시지 표시 성공률 100%

**Acceptance Scenarios**:
1. **Given** 사용자가 결제 페이지에 접근했을 때, **When** 페이지가 로드되면, **Then** 주문 정보가 자동으로 생성됨
2. **Given** 주문 정보가 생성되었을 때, **When** 정보가 표시되면, **Then** 생성된 주문 정보가 정확하게 표시됨
3. **Given** 주문 정보 생성에 실패했을 때, **When** 에러가 발생하면, **Then** 사용자에게 명확한 에러 메시지가 표시됨
4. **Given** 사용자가 주문 정보를 확인했을 때, **When** 정보가 표시되면, **Then** 주문 상세 정보를 조회할 수 있음

---

### US3: 사용자가 결제 과정에서 오류를 처리 (Priority: P2)

**시나리오**: 사용자가 결제를 진행하는 과정에서 오류가 발생했을 때 적절히 처리할 때

**사용자 행동**:
1. 사용자가 결제를 진행
2. 결제 과정에서 오류가 발생
3. 시스템이 오류 메시지를 표시
4. 사용자가 오류 메시지를 확인하고 재시도 또는 취소

**기대 결과**:
- 결제 오류 시 명확한 오류 메시지가 표시됨
- 사용자가 오류 원인을 이해할 수 있음
- 사용자가 결제를 재시도하거나 취소할 수 있음
- 오류 발생 시 주문 정보가 유지됨

**성공 기준**:
- 결제 오류 시 오류 메시지 표시 성공률 100%
- 오류 메시지의 명확성 평가 점수가 4점 이상 (5점 만점)
- 사용자가 오류 후 재시도하는 비율이 60% 이상
- 오류 발생 시 주문 정보 유지 성공률 100%

**Acceptance Scenarios**:
1. **Given** 사용자가 결제를 진행했을 때, **When** 결제 오류가 발생하면, **Then** 명확한 오류 메시지가 표시됨
2. **Given** 결제 오류가 발생했을 때, **When** 오류 메시지가 표시되면, **Then** 사용자가 오류 원인을 이해할 수 있음
3. **Given** 사용자가 결제 오류를 확인했을 때, **When** 재시도 버튼을 클릭하면, **Then** 결제를 다시 시도할 수 있음
4. **Given** 결제 오류가 발생했을 때, **When** 오류가 처리되면, **Then** 주문 정보가 유지됨

---

## 📋 기능 요구사항

### FR-001: 타임캡슐 정보 표시
**설명**: 사용자가 이전 단계에서 입력한 타임캡슐 정보를 확인할 수 있도록 표시합니다.

**요구사항**:
- 캡슐명이 표시되어야 함
- 참여 인원 수가 표시되어야 함
- 타임캡슐 가격이 표시되어야 함
- 정보가 명확하고 읽기 쉬운 형태로 표시되어야 함
- 정보 표시 실패 시 적절한 처리되어야 함

**검증 기준**:
- 캡슐명이 정확하게 표시됨
- 참여 인원 수가 정확하게 표시됨
- 타임캡슐 가격이 정확하게 표시됨
- 정보 표시 오류 발생 시 에러 메시지가 표시됨

### FR-002: 주문 정보 요약 표시
**설명**: 사용자가 주문 정보를 한눈에 확인할 수 있도록 요약 정보를 표시합니다.

**요구사항**:
- 주문 정보 요약이 표시되어야 함
- 주문 항목이 명확하게 표시되어야 함
- 주문 정보가 정확해야 함
- 주문 정보 표시 실패 시 적절히 처리되어야 함

**검증 기준**:
- 주문 정보 요약이 정상적으로 표시됨
- 주문 항목이 명확하게 표시됨
- 주문 정보가 정확함
- 주문 정보 표시 오류 발생 시 에러 메시지가 표시됨

### FR-003: 결제 금액 표시
**설명**: 사용자가 결제해야 할 총 금액을 명확하게 확인할 수 있도록 표시합니다.

**요구사항**:
- 총 결제 금액이 표시되어야 함
- 금액이 명확하고 읽기 쉬운 형태로 표시되어야 함
- 금액 계산이 정확해야 함
- 금액 표시 실패 시 적절히 처리되어야 함

**검증 기준**:
- 총 결제 금액이 정확하게 표시됨
- 금액이 명확하게 표시됨
- 금액 계산이 정확함
- 금액 표시 오류 발생 시 에러 메시지가 표시됨

### FR-004: 주문 생성
**설명**: 사용자가 결제를 진행하기 전에 주문 정보를 생성합니다.

**요구사항**:
- 결제 페이지 접근 시 주문 정보가 자동으로 생성되어야 함
- 주문 생성이 실패하면 적절한 에러 메시지가 표시되어야 함
- 주문 생성 중에는 로딩 상태가 표시되어야 함
- 주문 생성 성공 시 주문 정보가 저장되어야 함

**검증 기준**:
- 주문 정보가 자동으로 생성됨
- 주문 생성 실패 시 에러 메시지가 표시됨
- 주문 생성 중 로딩 상태가 표시됨
- 주문 생성 성공 시 주문 정보가 저장됨

### FR-005: 주문 정보 조회
**설명**: 생성된 주문 정보를 조회하여 표시합니다.

**요구사항**:
- 생성된 주문 정보를 조회할 수 있어야 함
- 주문 정보 조회가 실패하면 적절한 에러 메시지가 표시되어야 함
- 주문 정보 조회 중에는 로딩 상태가 표시되어야 함
- 조회된 주문 정보가 정확해야 함

**검증 기준**:
- 주문 정보가 정상적으로 조회됨
- 주문 정보 조회 실패 시 에러 메시지가 표시됨
- 주문 정보 조회 중 로딩 상태가 표시됨
- 조회된 주문 정보가 정확함

### FR-006: 토스 결제 위젯 연동
**설명**: 사용자가 토스 결제 위젯을 통해 안전하게 결제를 진행할 수 있도록 연동합니다.

**요구사항**:
- 토스 결제 위젯이 표시되어야 함
- 사용자가 결제 수단을 선택할 수 있어야 함
- 사용자가 결제 정보를 입력할 수 있어야 함
- 결제 프로세스가 안전하게 진행되어야 함
- 결제 완료 후 successUrl/failUrl로 리다이렉트되어야 함
- successUrl은 프론트엔드 도메인의 성공 페이지여야 함 (예: `/pay/toss/success`)
- failUrl은 프론트엔드 도메인의 실패 페이지여야 함 (예: `/pay/toss/fail`)

**검증 기준**:
- 토스 결제 위젯이 정상적으로 표시됨
- 사용자가 결제 수단을 선택할 수 있음
- 사용자가 결제 정보를 입력할 수 있음
- 결제 프로세스가 안전하게 진행됨
- 결제 완료 후 successUrl/failUrl로 리다이렉트됨
- 리다이렉트 URL이 프론트엔드 도메인으로 설정됨

### FR-007: 토스 결제 최종 승인
**설명**: 토스 결제 위젯에서 결제가 완료된 후 백엔드에 최종 승인을 요청합니다.

**요구사항**:
- 결제 성공 페이지에서 URL 쿼리 파라미터로 paymentKey, orderId, amount를 받아야 함
- 백엔드에 결제 최종 승인 API (`POST /api/payments/toss/confirm`)를 호출해야 함
- 결제 승인 요청 시 JWT 인증 토큰이 포함되어야 함
- 결제 승인이 실패하면 적절한 에러 메시지가 표시되어야 함
- 결제 승인 중에는 로딩 상태가 표시되어야 함
- 결제 승인 성공 시 결제 정보 및 캡슐 ID를 받아야 함

**검증 기준**:
- 결제 성공 페이지에서 paymentKey, orderId, amount를 정확하게 받음
- 백엔드 결제 최종 승인 API 호출이 성공함
- 인증 토큰이 올바르게 포함됨
- 결제 승인 실패 시 에러 메시지가 표시됨
- 결제 승인 중 로딩 상태가 표시됨
- 결제 승인 성공 시 결제 정보 및 캡슐 ID를 받음

**에러 처리**:
- 400: AMOUNT_MISMATCH (결제 금액 불일치), ORDER_ALREADY_PAID (이미 결제 완료), TOSS_SECRET_KEY_REQUIRED, TOSS_CONFIRM_FAILED
- 401: ORDER_NOT_OWNED (주문 소유자 불일치), JWT 누락/만료
- 404: ORDER_NOT_FOUND (주문을 찾을 수 없음), PRODUCT_NOT_FOUND_OR_INVALID (상품 타입 불일치)

### FR-008: 결제 완료 처리
**설명**: 결제가 완료된 후 결과를 처리하고 사용자에게 피드백을 제공합니다.

**요구사항**:
- 결제 완료 시 성공 메시지가 표시되어야 함
- 결제 실패 시 실패 메시지가 표시되어야 함
- 결제 결과에 따라 적절한 후속 처리가 이루어져야 함
- 결제 완료 후 사용자가 다음 단계로 진행할 수 있어야 함

**검증 기준**:
- 결제 완료 시 성공 메시지가 표시됨
- 결제 실패 시 실패 메시지가 표시됨
- 결제 결과에 따라 적절한 후속 처리가 이루어짐
- 결제 완료 후 사용자가 다음 단계로 진행할 수 있음

---

## 🚀 비기능 요구사항 (NFR)

### 성능
- **NFR-001**: 결제 페이지 로드 시간이 2초 이하
- **NFR-002**: 주문 정보 생성 시간이 2초 이하
- **NFR-003**: 주문 정보 조회 시간이 1초 이하
- **NFR-004**: 결제 위젯 로드 시간이 3초 이하
- **NFR-005**: 결제 프로세스 응답 시간이 5초 이하

### 보안
- **NFR-006**: 모든 API 요청에 인증 토큰이 포함되어야 함
- **NFR-007**: 결제 정보는 안전하게 처리되어야 함
- **NFR-008**: 사용자 인증 상태가 유지되어야 함
- **NFR-009**: 결제 프로세스 중 보안 규칙이 준수되어야 함

### 접근성
- **NFR-010**: 모든 정보 표시 영역에 적절한 라벨이 제공됨
- **NFR-011**: 결제 위젯이 스크린 리더를 통해 접근 가능함
- **NFR-012**: 키보드만으로 모든 기능에 접근하고 사용할 수 있음
- **NFR-013**: 모든 인터랙티브 요소의 최소 터치 타겟 크기가 44px × 44px 이상

### 사용자 경험
- **NFR-014**: 주문 정보가 명확하고 이해하기 쉬움
- **NFR-015**: 결제 프로세스가 직관적이고 사용하기 쉬움
- **NFR-016**: 오류 메시지가 명확하고 이해하기 쉬움
- **NFR-017**: 결제 진행 상황을 사용자가 파악할 수 있음

### 호환성
- **NFR-018**: 주요 모바일 브라우저(Chrome, Safari, Firefox)에서 정상 동작
- **NFR-019**: 다양한 모바일 기기 화면 크기에서 레이아웃이 일관되게 표시됨
- **NFR-020**: 토스 결제 위젯이 모든 주요 브라우저에서 정상 작동함

---

## 🔍 엣지 케이스 및 예외 상황

### EC-001: 이전 페이지에서 정보가 전달되지 않은 경우
**상황**: 사용자가 결제 페이지에 직접 접근하거나 이전 페이지에서 정보가 전달되지 않음

**처리 방법**:
- 타임캡슐 생성 페이지로 리다이렉트
- 또는 사용자에게 정보 입력을 요청하는 메시지 표시

### EC-002: 주문 생성 실패
**상황**: 주문 정보 생성 API 호출이 실패함

**처리 방법**:
- 사용자에게 명확한 에러 메시지 표시
- 재시도 버튼 제공
- 문제가 지속되면 고객 지원 안내

### EC-003: 주문 정보 조회 실패
**상황**: 생성된 주문 정보를 조회하는 데 실패함

**처리 방법**:
- 사용자에게 명확한 에러 메시지 표시
- 재시도 버튼 제공
- 주문 정보가 없는 경우 주문 재생성 안내

### EC-004: 결제 위젯 로드 실패
**상황**: 토스 결제 위젯이 로드되지 않음

**처리 방법**:
- 사용자에게 명확한 에러 메시지 표시
- 페이지 새로고침 안내
- 문제가 지속되면 고객 지원 안내

### EC-005: 결제 프로세스 중 네트워크 오류
**상황**: 결제 진행 중 네트워크 연결이 끊김

**처리 방법**:
- 사용자에게 네트워크 오류 메시지 표시
- 결제 상태 확인 안내
- 재시도 옵션 제공

### EC-006: 결제 완료 후 결과 수신 실패
**상황**: 결제는 완료되었으나 결과를 수신하지 못함

**처리 방법**:
- 주문 정보를 다시 조회하여 결제 상태 확인
- 결제 완료 여부를 사용자에게 안내
- 문제가 지속되면 고객 지원 안내

### EC-007: 인증 토큰 만료
**상황**: 결제 페이지 사용 중 인증 토큰이 만료됨

**처리 방법**:
- 자동으로 토큰 갱신 시도
- 토큰 갱신 실패 시 로그인 페이지로 리다이렉트
- 사용자에게 적절한 안내 메시지 표시

---

## 🎨 디자인 제약사항

### Figma 디자인 준수
- **Figma 디자인 참조**: 결제 페이지의 디자인은 Figma 디자인 시안을 참조합니다
- **Figma 링크**: https://www.figma.com/design/KJVVnKITMTcrf9qIS7chiy/%ED%83%80%EC%9E%84%EC%BA%A1%EC%8A%90---%EC%9D%B4%EC%8A%A4%ED%84%B0%EC%97%90%EA%B7%B8--%EB%B3%B5%EC%82%AC-?node-id=111-91&t=GSF9XflGaRp0IBGw-4
- **디자인 정확도**: 모든 컴포넌트의 크기, 간격, 색상, 스타일은 Figma 디자인과 pixel-perfect 수준으로 일치해야 함
- **디자인 토큰 준수**: Figma에서 정의된 색상, 간격, 타이포그래피 등의 디자인 토큰을 프로젝트의 `tailwind.config.js`에 선언된 변수로 import하여 사용
- **중복 선언 금지**: 하드코딩된 색상 값 사용 금지, 기존에 정의된 테마 변수를 재사용

### 레이아웃
- **모바일 기준 고정값**: 레이아웃 너비는 모바일 기준 고정값으로 설정됨
- **일관성**: 모든 페이지에서 레이아웃 구조가 일관되게 유지됨

### 정보 표시 스타일
- **타임캡슐 정보 표시**: 이전 단계에서 입력한 정보가 명확하고 읽기 쉬운 형태로 표시됨
- **주문 정보 요약**: 주문 정보가 구조화되고 명확하게 표시됨
- **결제 금액 표시**: 결제 금액이 강조되어 표시됨

### 결제 위젯 스타일
- **토스 결제 위젯**: 토스 결제 위젯이 디자인 시스템과 조화롭게 통합됨
- **반응형 디자인**: 다양한 화면 크기에서 결제 위젯이 정상적으로 표시됨

---

## 📊 성공 지표 (KPI)

### 사용자 경험
- **결제 완료율**: 결제 페이지 접근 후 결제를 완료하는 비율이 85% 이상
- **주문 정보 확인 시간**: 사용자가 주문 정보를 확인하는 데 걸리는 평균 시간이 10초 이하
- **결제 프로세스 완료 시간**: 결제 프로세스 완료까지 걸리는 평균 시간이 2분 이하
- **재시도율**: 결제 실패 후 사용자가 다시 시도하는 비율이 60% 이상

### 기술적 품질
- **주문 생성 성공률**: 주문 정보 생성 성공률이 98% 이상
- **주문 정보 조회 성공률**: 주문 정보 조회 성공률이 99% 이상
- **결제 위젯 로드 성공률**: 결제 위젯 로드 성공률이 99% 이상
- **페이지 로드 성능**: 결제 페이지 로드 시간이 2초 이하인 비율이 95% 이상

### 비즈니스 지표
- **결제 전환율**: 타임캡슐 생성 페이지에서 결제 페이지로 이동 후 결제를 완료하는 비율이 80% 이상
- **사용자 만족도**: 사용자가 결제 프로세스에 대해 만족하는 비율이 85% 이상
- **결제 오류율**: 결제 프로세스 중 오류 발생률이 5% 이하

---

## 🔗 핵심 엔티티

### 주문 (Order)
주문 정보를 나타내는 엔티티입니다.

**주요 속성**:
- 주문 ID: 주문을 고유하게 식별하는 식별자
- 타임캡슐 정보: 캡슐명, 참여 인원 수, 가격 등
- 주문 상태: 주문의 현재 상태 (생성됨, 결제 대기, 결제 완료, 취소됨 등)
- 결제 금액: 총 결제 금액
- 생성 일시: 주문이 생성된 일시
- 결제 일시: 결제가 완료된 일시 (결제 완료 시)

### 타임캡슐 정보 (TimeCapsule Info)
이전 단계에서 입력한 타임캡슐 정보입니다.

**주요 속성**:
- 캡슐명: 타임캡슐의 이름
- 참여 인원 수: 타임캡슐에 참여할 인원 수
- 가격: 타임캡슐의 가격

### 결제 정보 (Payment Info)
결제와 관련된 정보입니다.

**주요 속성**:
- 결제 금액: 총 결제 금액
- 결제 수단: 선택한 결제 수단
- 결제 상태: 결제의 현재 상태 (대기, 진행 중, 완료, 실패)
- 결제 결과: 결제 완료 또는 실패 결과

---

## 📝 가정사항

### 사용자 환경
- 사용자는 모바일 기기에서 웹 애플리케이션을 주로 사용함
- 사용자는 터치 인터페이스에 익숙함
- 사용자는 타임캡슐 생성 과정에 대해 기본적인 이해를 가지고 있음
- 사용자는 결제 프로세스에 대해 기본적인 이해를 가지고 있음

### 기술 환경
- 인증된 사용자만 결제 페이지에 접근할 수 있음
- 개발 환경에서 사용할 인증 토큰은 `.env.local` 파일의 `NEXT_PUBLIC_DEV_TOKEN` 환경 변수로 선언되어 있음
- 모든 API 요청 시 인증 토큰이 필요함
- 토스 결제 위젯이 정상적으로 작동함
- 이전 페이지에서 타임캡슐 정보가 전달됨

### 비즈니스 규칙
- 주문은 결제 전에 생성되어야 함
- 주문 정보는 정확해야 함
- 결제 금액은 타임캡슐 가격과 일치해야 함
- 결제는 토스 결제 위젯을 통해 진행됨

### 데이터 전달
- 이전 페이지에서 타임캡슐 정보가 전달됨
- 주문 정보는 API를 통해 생성되고 조회됨
- 결제 결과는 토스 결제 위젯을 통해 전달됨

---

## 🚧 향후 확장 가능성

### 향후 개선 사항
- 결제 수단 선택 옵션 확대
- 결제 내역 조회 기능
- 결제 취소 및 환불 기능
- 결제 알림 기능
- 결제 프로세스 개선

### 확장 가능한 기능
- 여러 타임캡슐 일괄 결제
- 할인 쿠폰 적용
- 포인트 적립 및 사용
- 정기 결제 옵션
- 결제 방법 저장
