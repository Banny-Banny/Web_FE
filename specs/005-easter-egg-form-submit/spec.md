# 기능 명세서: 이스터에그 폼 제출

## 개요

사용자가 이스터에그 바텀시트에서 작성한 폼 데이터를 서버에 전송하여 이스터에그를 생성하는 기능입니다. 사용자가 제목, 메시지, 첨부파일을 입력하고 작성 완료 버튼을 클릭하면, 현재 위치 정보와 함께 서버로 전송되어 이스터에그가 생성됩니다.

### 배경

현재 이스터에그 바텀시트는 폼 작성 기능만 구현되어 있으며, 작성 완료 버튼 클릭 시 콘솔 로그만 출력됩니다. 실제로 서버에 데이터를 전송하여 이스터에그를 생성하는 기능이 필요합니다.

### 목적

- 사용자가 작성한 이스터에그 데이터를 서버에 저장
- 현재 위치 정보를 자동으로 포함하여 이스터에그 생성
- 첨부파일(이미지, 음원, 동영상)을 포함한 멀티미디어 데이터 전송
- 폼 제출 과정에서 사용자에게 적절한 피드백 제공

## 기능 요구사항

### FR-1: 폼 제출 시 위치 정보 자동 포함

**설명**: 사용자가 작성 완료 버튼을 클릭하면, 현재 사용자의 위치 정보(위도, 경도)가 자동으로 폼 데이터에 포함되어 전송됩니다.

**수락 기준**:
- 작성 완료 버튼 클릭 시 현재 위치 정보가 자동으로 수집됨
- 위치 정보 수집 실패 시 사용자에게 명확한 안내 메시지 표시
- 위치 정보가 없는 경우 이스터에그 생성이 진행되지 않음
- 위치 정보 수집 중에는 로딩 상태를 표시함

### FR-2: 폼 데이터 검증 및 변환

**설명**: 사용자가 입력한 폼 데이터를 서버 API 형식에 맞게 검증하고 변환합니다.

**수락 기준**:
- 제목이 30자를 초과하는 경우 제출이 차단되고 에러 메시지 표시
- 메시지가 500자를 초과하는 경우 제출이 차단되고 에러 메시지 표시
- 첨부파일이 10개를 초과하는 경우 제출이 차단되고 에러 메시지 표시
- 필수 필드(제목, 위치 정보)가 누락된 경우 제출이 차단되고 에러 메시지 표시
- 모든 검증을 통과한 경우에만 서버로 데이터 전송

### FR-3: 멀티미디어 파일 업로드

**설명**: 사용자가 첨부한 이미지, 음원, 동영상 파일을 서버로 전송합니다.

**수락 기준**:
- 첨부된 모든 미디어 파일이 서버로 전송됨
- 파일 전송 중 진행 상태를 사용자에게 표시함
- 파일 전송 실패 시 사용자에게 명확한 에러 메시지 표시
- 파일 전송 성공 시 이스터에그 생성이 완료됨
- 최대 3개(미디어, 음원, 동영상 각 1개식)의 미디어 파일을 전송할 수 있음

### FR-4: 서버 응답 처리

**설명**: 서버로부터 받은 응답을 처리하고 사용자에게 적절한 피드백을 제공합니다.

**수락 기준**:
- 이스터에그 생성 성공 시 성공 메시지를 표시하고 바텀시트가 닫힘
- 이스터에그 생성 실패 시 에러 메시지를 표시하고 폼 상태 유지
- 슬롯이 부족한 경우(409 에러) 사용자에게 명확한 안내 메시지 표시
- 네트워크 오류 시 재시도 옵션 제공
- 서버 응답 처리 중에는 적절한 로딩 상태 표시

### FR-5: 제출 중 상태 관리

**설명**: 폼 제출 중에는 사용자가 중복 제출을 방지하고 진행 상태를 확인할 수 있어야 합니다.

**수락 기준**:
- 제출 버튼 클릭 후 제출이 완료될 때까지 버튼이 비활성화됨
- 제출 중에는 로딩 인디케이터가 표시됨
- 제출 중에는 폼 필드가 수정 불가능한 상태가 됨
- 제출 중에는 바텀시트가 닫히지 않음
- 제출 완료 또는 실패 후에는 정상 상태로 복원됨

## 사용자 시나리오

### 시나리오 1: 이스터에그 생성 성공

1. 사용자가 이스터에그 바텀시트에서 제목과 메시지를 입력함
2. 사용자가 사진을 첨부함
3. 사용자가 "작성 완료" 버튼을 클릭함
4. 시스템이 현재 위치 정보를 자동으로 수집함
5. 시스템이 폼 데이터를 검증함
6. 시스템이 서버로 데이터를 전송함
7. 서버가 이스터에그를 성공적으로 생성함
8. 성공 메시지가 표시되고 바텀시트가 닫힘
9. 홈 화면으로 돌아가고 새로 생성된 이스터에그가 지도에 표시됨

### 시나리오 2: 위치 정보 수집 실패

1. 사용자가 이스터에그 바텀시트에서 제목과 메시지를 입력함
2. 사용자가 "작성 완료" 버튼을 클릭함
3. 시스템이 위치 정보를 수집하려고 시도하지만 실패함 (권한 거부 또는 오류)
4. 사용자에게 위치 정보가 필요하다는 안내 메시지가 표시됨
5. 위치 권한 설정 방법이 안내됨
6. 바텀시트는 열린 상태로 유지되고 폼 데이터는 보존됨
7. 사용자가 위치 권한을 허용한 후 다시 시도할 수 있음

### 시나리오 3: 슬롯 부족으로 인한 생성 실패

1. 사용자가 이스터에그 바텀시트에서 모든 정보를 입력함
2. 사용자가 "작성 완료" 버튼을 클릭함
3. 시스템이 서버로 데이터를 전송함
4. 서버가 슬롯이 부족하다는 응답(409)을 반환함
5. 사용자에게 슬롯이 부족하다는 명확한 메시지가 표시됨
6. 사용자에게 슬롯을 확보하는 방법이 안내됨
7. 바텀시트는 열린 상태로 유지되고 폼 데이터는 보존됨

### 시나리오 4: 네트워크 오류 처리

1. 사용자가 이스터에그 바텀시트에서 모든 정보를 입력함
2. 사용자가 "작성 완료" 버튼을 클릭함
3. 네트워크 연결이 끊어지거나 서버 응답이 없음
4. 사용자에게 네트워크 오류 메시지가 표시됨
5. 재시도 버튼이 제공됨
6. 사용자가 재시도 버튼을 클릭하면 다시 전송을 시도함
7. 네트워크가 복구되면 정상적으로 이스터에그가 생성됨

### 시나리오 5: 파일 업로드 진행 상태 표시

1. 사용자가 이스터에그 바텀시트에서 여러 개의 큰 파일을 첨부함
2. 사용자가 "작성 완료" 버튼을 클릭함
3. 파일 업로드가 시작되고 진행률이 표시됨
4. 사용자가 업로드 진행 상황을 실시간으로 확인할 수 있음
5. 모든 파일 업로드가 완료되면 이스터에그 생성이 완료됨
6. 성공 메시지가 표시되고 바텀시트가 닫힘

## 성공 기준

### SC-1: 기능 완성도

- 이스터에그 생성 성공률이 95% 이상
- 위치 정보 수집 성공률이 90% 이상
- 파일 업로드 성공률이 98% 이상
- 모든 필수 필드 검증이 정확하게 수행됨
- 에러 상황에 대한 적절한 처리 및 사용자 안내 제공

### SC-2: 사용자 경험 품질

- 폼 제출 완료까지 소요 시간이 5초 이하 (일반적인 네트워크 환경)
- 제출 중 사용자가 진행 상태를 명확히 파악할 수 있음
- 에러 메시지가 명확하고 사용자가 다음 행동을 취할 수 있도록 안내됨
- 제출 실패 후에도 사용자가 쉽게 재시도할 수 있음
- 제출 성공 후 사용자가 명확한 피드백을 받음

### SC-3: 데이터 무결성

- 전송된 데이터가 서버에 정확하게 저장됨
- 위치 정보가 올바르게 포함됨
- 첨부파일이 손상 없이 전송됨
- 제목과 메시지가 올바른 길이 제한 내에서 전송됨

### SC-4: 오류 처리 완성도

- 모든 예상 가능한 오류 상황에 대한 처리가 구현됨
- 사용자가 오류 원인을 이해할 수 있는 메시지 제공
- 오류 발생 시 사용자가 취할 수 있는 조치가 명확히 안내됨
- 오류 후에도 사용자 데이터가 보존됨

## 핵심 엔티티

### 이스터에그 생성 요청 데이터

**설명**: 서버로 전송되는 이스터에그 생성 요청 데이터

**속성**:
- `latitude` (number, 필수): 위도
- `longitude` (number, 필수): 경도
- `title` (string, 선택, 최대 100자): 이스터에그 제목
- `message` (string, 선택, 최대 500자): 메시지 내용
- `media_files` (File[], 선택, 최대 10개): 첨부 미디어 파일 배열
- `view_limit` (number, 선택): 선착순 인원 제한 (0이면 무제한)
- `product_id` (string, 선택, deprecated): 레거시 상품 ID

### 이스터에그 생성 응답

**설명**: 서버로부터 받는 이스터에그 생성 응답

**속성**:
- `success` (boolean): 생성 성공 여부
- `data` (object): 생성된 이스터에그 정보
- `message` (string): 응답 메시지
- `error` (object, 선택): 에러 정보 (실패 시)

## 비기능 요구사항

### NFR-1: 성능

- 폼 제출 요청이 3초 이내에 완료됨 (일반적인 네트워크 환경)
- 파일 업로드 진행률이 실시간으로 업데이트됨
- 위치 정보 수집이 2초 이내에 완료됨
- 제출 중 UI 반응성이 유지됨

### NFR-2: 안정성

- 네트워크 오류 시 자동 재시도 메커니즘 제공 (선택적)
- 제출 실패 시 사용자 데이터가 보존됨
- 서버 오류 시 적절한 폴백 처리
- 타임아웃 상황에 대한 적절한 처리

### NFR-3: 보안

- 모든 API 요청에 인증 토큰이 포함됨
- 사용자 위치 정보가 안전하게 전송됨
- 파일 업로드 시 적절한 파일 타입 검증 수행

### NFR-4: 접근성

- 제출 중 상태가 스크린 리더를 통해 읽을 수 있음
- 에러 메시지가 스크린 리더를 통해 읽을 수 있음
- 키보드만으로 모든 기능 사용 가능

## 제약사항

### 기술적 제약사항

- API 엔드포인트는 `POST /api/capsules`를 사용함
- 요청 형식은 `multipart/form-data`여야 함
- 위치 정보(latitude, longitude)는 필수 항목임
- 미디어 파일은 form-data로 직접 업로드해야 함
- 슬롯이 없으면 409 에러가 반환됨

### 비즈니스 제약사항

- 제목은 최대 30자까지 입력 가능
- 메시지는 최대 500자까지 입력 가능
- 미디어 파일은 최대 3개(미디어, 음원, 영상 각 1개)까지 첨부 가능
- product_id는 deprecated 필드로 이스터에그에 저장되지 않음

### 사용자 경험 제약사항

- 위치 정보가 없으면 이스터에그를 생성할 수 없음
- 제출 중에는 사용자가 폼을 수정할 수 없음
- 제출 실패 시 사용자가 입력한 데이터는 보존되어야 함

## 가정사항

### 기술 가정

- 사용자의 브라우저가 Geolocation API를 지원함
- 사용자가 위치 권한을 허용할 수 있음
- 네트워크 연결이 일반적으로 안정적임
- API 서버가 정상적으로 동작함
- api-client.ts를 통해 API 통신이 수행됨

### 사용자 가정

- 사용자가 위치 권한 허용에 동의함
- 사용자가 네트워크 연결 상태를 확인할 수 있음
- 사용자가 파일 업로드에 필요한 시간을 이해함

### 비즈니스 가정

- 사용자가 이스터에그를 생성할 충분한 슬롯을 보유함
- 서버가 이스터에그 생성 요청을 처리할 수 있는 상태임

## 엣지 케이스

### EC-1: 위치 정보 수집 시간 초과

**상황**: 위치 정보 수집이 10초 이상 걸리는 경우

**처리**:
- 타임아웃 메시지를 표시함
- 사용자에게 위치 권한 설정을 확인하도록 안내함
- 재시도 옵션을 제공함

### EC-2: 매우 큰 파일 업로드

**상황**: 사용자가 매우 큰 파일(예: 100MB 이상)을 첨부한 경우

**처리**:
- 파일 크기 제한을 사전에 검증함
- 업로드 진행률을 명확히 표시함
- 업로드 시간이 오래 걸릴 수 있음을 사용자에게 안내함

### EC-3: 제출 중 브라우저 종료

**상황**: 사용자가 제출 중 브라우저를 닫거나 페이지를 떠남

**처리**:
- 브라우저가 제출 완료를 기다리도록 안내 (선택적)
- 또는 제출이 백그라운드에서 계속 진행되도록 처리 (선택적)
- 기본적으로는 제출이 중단됨

### EC-4: 동시에 여러 이스터에그 생성 시도

**상황**: 사용자가 빠르게 여러 번 제출 버튼을 클릭

**처리**:
- 첫 번째 제출 후 버튼을 즉시 비활성화하여 중복 제출 방지
- 디바운싱 또는 스로틀링 적용
- 진행 중인 제출이 완료될 때까지 추가 제출 차단

### EC-5: 서버 응답 지연

**상황**: 서버 응답이 10초 이상 지연되는 경우

**처리**:
- 타임아웃 설정 (예: 30초)
- 타임아웃 발생 시 사용자에게 알림
- 재시도 옵션 제공

## 참고사항

### API 스펙

- **엔드포인트**: `POST /api/capsules`
- **요청 형식**: `multipart/form-data`
- **필수 필드**: `latitude`, `longitude`
- **선택 필드**: `title` (최대 30자), `message` (최대 500자), `media_files` (최대 3개), `view_limit`, `product_id` (deprecated)
- **에러 응답**: 
  - 409: 슬롯 부족
  - 400: 잘못된 요청 데이터
  - 401: 인증 실패
  - 500: 서버 오류

### 관련 컴포넌트

- `src/components/home/components/easter-egg-bottom-sheet/`: 이스터에그 바텀시트 컴포넌트
- `src/components/home/hooks/useGeolocation.ts`: 위치 정보 수집 훅
- `src/commons/provider/api-provider/api-client.ts`: API 클라이언트

### 구현 단계 제안

이 명세서는 구현 세부사항을 포함하지 않지만, 다음 단계인 기술 계획 수립 시 다음 단계들을 고려할 것을 권장합니다:

1. **Phase 1**: API 엔드포인트 함수 생성 및 타입 정의
2. **Phase 2**: 폼 데이터 검증 및 변환 로직 구현
3. **Phase 3**: 위치 정보 수집 및 포함 로직 구현
4. **Phase 4**: 멀티미디어 파일 업로드 처리
5. **Phase 5**: 서버 응답 처리 및 에러 핸들링
6. **Phase 6**: 사용자 피드백 및 상태 관리
7. **Phase 7**: 테스트 및 최적화

---

**문서 버전**: 1.0.0  
**작성일**: 2026-01-27  
**다음 단계**: `/speckit.plan` 명령어로 기술 계획 수립
